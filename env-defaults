#!/bin/bash
# Default values.
# Override with -e VAR=value option.

echo "LOADING DEFAULTS"

ADDRESS=$(curl http://checkip.amazonaws.com)
PORT=${PORT:-27015}

STEAM_APP=${STEAM_APP:-csgo}
STEAM_APP_ID=${STEAM_APP_ID:-740}

STEAM_APP_DIR=${STEAM_APP_DIR:-/opt/csgo}
STEAM_DIR=${STEAM_DIR:-/opt/steamcmd}

APPLICATION_ID=${APPLICATION_ID:-}
INTERACTION_TOKEN=${INTERACTION_TOKEN:-}
EXECUTION_NAME=${EXECUTION_NAME:-}

WORKFLOW_ENDPOINT=${WORKFLOW_ENDPOINT:-}

# Server start variables
FPS_MAX=${FPS-MAX:-300}
TICK_RATE=${TICK-RATE:-128}
PORT=${PORT:-27015}
TV_PORT=${TV-PORT:-27020}
CLIENT_PORT=${CLIENT-PORT:-27005}
MAX_PLAYERS=${MAX-PLAYERS:-10}
GSL_TOKEN=${GSL_TOKEN:-0} \
RCON_PASSWORD=${RCON-PASSWORD:-"ServerBoi"}
PASSWORD=${PASSWORD:-""}
START_MAP=${START-MAP:-"de_dust2"}
REGION=${REGION:-255}
MAP_GROUP=${MAP-GROUP:-"mg_active"}
GAME_TYPE=${GAME-TYPE:-0}
GAME_MODE=${GAME-MODE:-1}
SERVER_NAME=${SERVER_NAME:-"ServerBoi-CSGO"} 


download_client() {
     bash "${STEAM_DIR}/steamcmd.sh" +login anonymous \
        +force_install_dir "${STEAM_APP_DIR}" \
        +app_update "${STEAM_APP_ID}" \
        +quit
}
DOWNLOAD_CLIENT=download_client

run_client() {
    bash screen -d -m "${STEAM_APP_DIR}/srcds_run" -game "${STEAM_APP}" -console -autoupdate \
			-steam_dir "${STEAM_DIR}" \
			-steamcmd_script "${HOME_DIR}/${STEAM_APP}_update.txt" \
			-usercon \
			+fps_max "${FPS_MAX}" \
			-tickrate "${TICK_RATE}" \
			-port "${PORT}" \
			+tv_port "${TV_PORT}" \
			+clientport "${CLIENT_PORT}" \
			-maxplayers_override "${MAX_PLAYERS}" \
			+game_type "${GAME_TYPE}" \
			+game_mode "${GAME_MODE}" \
			+mapgroup "${MAP_GROUP}" \
			+map "${START_MAP}" \
			+sv_setsteamaccount "${GSL_TOKEN}" \
			+sv_region "${REGION}" 
}
RUN_CLIENT=run_client

QUERY_SERVER='python3 /opt/serverboi/scripts/ping_server.py change-stage --stage=Verifying-Client'